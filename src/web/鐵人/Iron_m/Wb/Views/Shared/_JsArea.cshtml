@using Wb.Common
<script src="@Url.Content("~/templates/default/js/jquery-1.11.0.min.js")"></script>
<script src="@Url.Content("~/templates/default/js/fancybox/source/jquery.fancybox.pack.js?v=2.1.5")"></script>
<script src="@Url.Content("~/templates/default/js/web.js")"></script>
<script>
$(function () {

    var right_navi_btn = $('#member_btn'),
    block_area = $('#block_area'),
    content_frame = $('#member_panel');

    right_navi_btn.click(function () {
        if (content_frame.hasClass('this_close') || !content_frame.hasClass('this_open_right')) {

            content_frame.removeClass('this_close').addClass('this_open_right');

            block_area.show().click(content_frame_recovery);
        }


        return false;
    })


    function content_frame_recovery() {
        content_frame.removeClass('this_open_right').addClass('this_close');
        block_area.hide();
        return false;
    }


    if ("msgbox" != "@ViewBag.cur_action")
    {
        $('.call_pager').fancybox({
            closeBtn: false
        });
    }

})

</script>


@Html.Raw(ViewBag.js)

@if(ViewBag.member_edit !=null)
{
 <script>

     $(function () {

         var birth_row = $('#datepicker').parents('tr');

         $("#datepicker").datepicker({
             changeMonth: true,
             changeYear: true,
             showMonthAfterYear: true,
             monthNames: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
             monthNamesShort: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
             yearRange: "1940:2010",
             onSelect: function (dateText, inst) {
                 $('#birthday').val(dateText);
                 birth_row.hide('fast');
             },
             dateFormat: "yy-mm-dd"
         });


         /*birthday */




         $('#calendar_icon').click(function () {
             if (birth_row.is(":hidden")) {
                 birth_row.show('fast');
             }
         })


     })
</script>
}

@*@if (ViewBag.cur_controller == "forum" || ViewBag.cur_controller == "team")
{*@
<script>
    //push_up(1,"push_result.json");
    //JsArea

    $(function () {
        $('.push_btn').click(function () {
            if (!$(this).hasClass('processing')) {
                $(this).addClass('processing')
                push_up($(this).attr('sn'), $(this).attr('href'), $(this));
            }

            return false;

        })

    })


    $(function () {
        $('.join_btn').click(function () {
            if (!$(this).hasClass('processing')) {
                $(this).addClass('processing')
                push_up($(this).attr('sn'), $(this).attr('href'), $(this));
            }
            return false;
        })
    })


</script>
@*}*@


@if (ViewBag.cur_controller == "member" || ViewBag.cur_controller == "info")
{
<script>
    
    $(function () {
        $('.join_add_friend').click(function () {
            if (!$(this).hasClass('processing')) {
                $(this).addClass('processing')
                push_up($(this).attr('sn'), $(this).attr('href'), $(this));
            }
            return false;
        })
    })


</script>
}

@if (ViewBag.cur_controller == "member" || ViewBag.cur_controller == "friends")
{
<script>

    $(function () {
        $('.friend_check_btn').click(function () {
            if (!$(this).hasClass('processing')) {
                $(this).addClass('processing')
                push_up($(this).attr('sn'), $(this).attr('href'), $(this));
            }
            return false;
        })
    })


</script>
}

@if (ViewBag.cur_controller == "member" && ViewBag.cur_action == "msgbox")
{

   <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="@Url.Content("~/Scripts/jquery-1.8.2.min.js")" ></script>
    <script src="@Url.Content("~/Scripts/jquery-ui-1.8.24.min.js")" ></script>
    <!--Reference the SignalR library. -->
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.0.3.min.js")"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="@Url.Content("~/signalr/hubs")"></script>
    <!--Add script to update the page and send messages.--> 
    <script type="text/javascript">



        function scrollEnd() {
            $(document).scrollTop(9999999);
            return false;
        }

        function scrollTop() {
            $(document).scrollTop(0);
            return false;
        }

        $(function () {
            scrollEnd();
            startChatHub();

            $('#btn_pre_message').click(function () {
                $.ajax
                (
                    {
                        type: "GET",
                        url: "@Url.RouteUrl("Default", new { controller = "member",action="AjaxShowPreMessage"})",
                        timeout: 3000,
                        data: { 'f_molo_key': '@ViewBag.f_molo', 'first_date': $('#first_date').val() },
                        dataType: "json",
                        error: function (xhr) {
                            //不處理
                        },
                        success: function (vData) {
                            var pre_msg = '';
                            for (var i = 0; i < vData.length; i++) {
                                if (i == 0) {
                                    $('#first_date').val(vData[i].org_post_date);                                    
                                }
                                if (vData[i].poster == $('#nickname').val()) {
                                    pre_msg += '<li class="guest"><div class="message">' + vData[i].message + '<span>' + vData[i].post_date + '</span><div class="right_arrow"></div></div><div class="img"><img src="@ViewBag.user_icon" onerror="this.src=\'@Url.Content("~/upload/website/default.png")\'" alt=""></div></li>';
                                } else {
                                    pre_msg += '<li><div class="img"><img src="@ViewBag.friend_icon" onerror="this.src=\'@Url.Content("~/upload/website/default.png")\'" alt=""></div><div class="message">' + vData[i].message + '<span>' + vData[i].post_date + '</span><div class="left_arrow"></div></div></li>';
                                }
                                pre_msg += '<br clear="all" />';
                            }

                            
                            var msg_log = $('#chat_box').html();                          
                            var res = pre_msg.concat(msg_log);
                            $('#chat_box').html(res);
                        }
                    }
                );

                return false;
            })

        });
        

        function startChatHub() {

            $.connection.hub.start({ transport: 'longPolling' }).done(function (myHubConnection) { });

            var chat = $.connection.chatHub;
            


            chat.client.differentName = function (name) {
                return false;
                // Prompts for different user name
                chat.server.notify($('#nickname').val(), $.connection.hub.id);
            };


            chat.client.online = function (name) {
                // Update list of users
                if (name == $('#nickname').val()) {
                    //$('#onlineusers').append('<div class="border" style="color:green">You: ' + name + '</div>');
                } else {
                    //$('#onlineusers').append('<div class="border">' + name + '</div>');
                    //$("#users").append('<option value="' + name + '">' + name + '</option>');
                }
            };



            chat.client.enters = function (name) {
                //$('#chatlog').append('<div style="font-style:italic;"><i>' + name + ' joins the conversation</i></div>');
                //$("#users").append('<option value="' + name + '">' + name + '</option>');
                //$('#onlineusers').append('<div class="border">' + name + '</div>');
            };


            chat.client.broadcastMessage = function (name, message) {

                var d = new Date();
                var post_date = d.getHours() + ":" + d.getMinutes();

                //display the message
                //$('#chat_box').append('<div class="border"><span style="color:orange">' + name + '</span>: ' + message + '</div>');
                if (name == $('#nickname').val()) {
                    $('#chat_box').append('<li class="guest"><div class="message">' + message + '<span>' + post_date + '</span><div class="right_arrow"></div></div><div class="img"><img src="@ViewBag.user_icon" onerror="this.src=\'@Url.Content("~/upload/website/default.png")\'" alt=""></div></li>');
                   
                } else {
                    $('#chat_box').append('<li><div class="img"><img src="@ViewBag.friend_icon" onerror="this.src=\'@Url.Content("~/upload/website/default.png")\'" alt=""></div><div class="message">' + message + '<span>' + post_date + '</span><div class="left_arrow"></div></div></li>');
                   
                }
                $('#chat_box').append('<br clear="all" />');

               
                scrollEnd();
            };



            chat.client.disconnected = function (name) {
                //Calls when someone leaves the page
                //$('#chatlog').append('<div style="font-style:italic;"><i>' + name + ' leaves the conversation</i></div>');
                //$('#onlineusers div').remove(":contains('" + name + "')");
                //$("#users option").remove(":contains('" + name + "')");
            }



            // Start the connection.

            $.connection.hub.start().done(function () {

                //Calls the notify method of the server
                chat.server.notify($('#nickname').val(), $.connection.hub.id);
                $('#send').click(function () {
                   
                    chat.server.sendToSpecific($('#nickname').val(), $('#message').val(), $("#f_nickname").val());

                    // Clear text box and reset focus for next comment. 
                    $('#message').val('').focus();
                    //scrollEnd();
                });
            });

        }


    </script>
}

